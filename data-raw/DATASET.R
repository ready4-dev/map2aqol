## This script creates the data files embedded with this package.
## As it involves interaction, it must be run  in four separate parts.
##
## PART ONE
##
# 1. Load magrittr package to that the pipe operator ("%>%") can be used in this script.
library(magrittr)
# 2. Create "fns", "gnrcs" and "mthds" sub-directories.
ready4fun::write_fn_type_dirs()
# 3. MANUAL STEP. Write all your functions to R files in the new "fns" directory.
##
## PART TWO
##
# 4. Set-up package structure
ready4fun::make_pkg_desc_ls(pkg_title_1L_chr = "Youth Outcomes to Health Utility",
                            pkg_desc_1L_chr = "Tools for mapping measures routinely collected in youth mental health services to AQOL 6D Health Utility. Part of the First Bounce model of primary youth mental health services.
  This development version of the youthu package has been made available as part of the process of testing and documenting the package. The tools contained in this development release are based on placeholder models estimated from synthetic data and are for demonstration purposes only and they should not yet be used to inform policy decisions. If you have any questions, please contact the authors (matthew.hamilton@orygen.org.au).
  The documentation for this package has been automatically generated by the ready4fun package and is therefore quite rudimentary. Human authored documentation will follow in 2021.",
                            authors_prsns = c(utils::person(given = "Matthew",family = "Hamilton",email = "matthew.hamilton@orygen.org.au", role = c("aut", "cre"),comment = c(ORCID = "0000-0001-7407-9194")),
                                              utils::person(given = "Caroline",family = "Gao",email = "caroline.gao@orygen.org.au", role = c("aut"),comment = c(ORCID = "0000-0002-0987-2759")),
                                              utils::person("Orygen", role = c("cph", "fnd")),
                                              utils::person("Headspace", role = c( "fnd")),
                                              utils::person("National Health and Medical Research Council", role = c( "fnd"))),
                            urls_chr = c("https://ready4-dev.github.io/youthu/",
                                         "https://github.com/ready4-dev/youthu",
                                         "https://ready4-dev.github.io/ready4/")) %>%
  ready4fun::write_pkg_setup_fls(incr_ver_1L_lgl = F,
                                 delete_contents_of_R_dir = T,
                                 copyright_holders_chr = "Orygen",
                                 check_type_1L_chr = "gh",
                                 path_to_pkg_logo_1L_chr = "../../../../../Documentation/Images/youthu-logo/default.png",
                                 github_repo = "ready4-dev/youthu",
                                 lifecycle_stage_1L_chr = "experimental",
                                 badges_lup = ready4fun::badges_lup,
                                 addl_badges_ls = list(ready4 = "prediction"))
## PAUSE FOR INTERACTION
##
## PART THREE
##
classes_to_make_tb <- ready4class::ready4_constructor_tbl() %>%
  dplyr::bind_rows(tibble::tribble(
    ~ make_s3_lgl, ~ name_stub_chr, ~ pt_ls, ~ pt_chkr_pfx_ls, ~ pt_ns_ls, ~ vals_ls, ~ allowed_vals_ls, ~ min_max_vals_ls, ~ start_end_vals_ls, ~ class_desc_chr, ~ parent_class_chr, ~ slots_ls, ~ meaningful_nms_ls, ~inc_clss_ls,
    TRUE, "aqol6d_adol", list("numeric"), list("is."),list("base"),NULL, NULL,list(c(0.03,1)), NULL, "First Bounce S3 class for Assessment of Quality of Life Six Dimension Health Utility - Adolescent Version (AQoL6d Adolescent))", NA_character_, NULL, NULL, NULL,
    TRUE, "phq9", list("integer"), list("is."),list("base"),NULL, NULL,list(c(0,27)), NULL, "First Bounce S3 class for Patient Health Questionnaire (PHQ-9) scores", NA_character_, NULL, NULL, NULL,
    TRUE, "bads", list("integer"), list("is."),list("base"),NULL, NULL,list(c(0,150)), NULL, "First Bounce S3 class for Behavioural Activation for Depression Scale (BADS) scores", NA_character_, NULL, NULL, NULL,
    TRUE, "gad7", list("integer"), list("is."),list("base"),NULL, NULL,list(c(0,21)), NULL, "First Bounce S3 class for Generalised Anxiety Disorder Scale (GAD-7) scores", NA_character_, NULL, NULL, NULL,
    TRUE, "oasis", list("integer"), list("is."),list("base"),NULL, NULL,list(c(0,20)), NULL, "First Bounce S3 class for Overall Anxiety Severity and Impairment Scale (OASIS) scores", NA_character_, NULL, NULL, NULL,
    TRUE, "scared", list("integer"), list("is."),list("base"),NULL, NULL,list(c(0,82)), NULL, "First Bounce S3 class for Screen for Child Anxiety Related Disorders (SCARED) scores", NA_character_, NULL, NULL, NULL,
    TRUE, "k6", list("integer"), list("is."),list("base"),NULL, NULL,list(c(0,24)), NULL, "First Bounce S3 class for Kessler Psychological Distress Scale (K6) - US Scoring System scores", NA_character_, NULL, NULL, NULL,
    TRUE, "sofas", list("integer"), list("is."),list("base"),NULL, NULL,list(c(0,100)), NULL, "First Bounce S3 class for Social and Occupational Functioning Assessment Scale (SOFAS)", NA_character_, NULL, NULL, NULL)
  )
name_pfx_1L_chr <- "firstbounce_"

pkg_dss_tb <- ready4fun::write_abbr_lup(short_name_chr = c(paste0(name_pfx_1L_chr,classes_to_make_tb$name_stub_chr),
                                                           "smry"),
                                        long_name_chr = c(classes_to_make_tb$class_desc_chr,
                                                          "summary"),
                                        #no_plural_chr = ,
                                        custom_plural_ls = list(summary = "summaries"),
                                        url_1L_chr = NA_character_,
                                        seed_lup = TTU::abbreviations_lup) # CHANGE
utils::data("abbreviations_lup")
pkg_dss_tb <- classes_to_make_tb %>%
  ready4class::write_classes_and_make_lup(dev_pkg_ns_1L_chr = ready4fun::get_dev_pkg_nm(),
                                          name_pfx_1L_chr = name_pfx_1L_chr,
                                          output_dir_1L_chr = "R",
                                          file_exists_cdn_1L_chr = "overwrite",
                                          abbreviations_lup = abbreviations_lup,
                                          init_class_pt_lup = ready4use::prototype_lup)  %>% # UPDATE TO READY4U WHEN CLASSES ARE ADDED
  ready4fun::write_and_doc_ds(db_1L_chr = "prototype_lup",
                              title_1L_chr = "Class prototype lookup table",
                              desc_1L_chr = "Metadata on classes used in readyforwhatsnext suite",
                              pkg_dss_tb = pkg_dss_tb)
# 5. Create function types and generics look-up tables
# 5.1 Create a lookup table of function types used in this package and save it as a package dataset (data gets saved in the data directory, documentation script is created in R directory).
utils::data("fn_type_lup_tb",package = "TTU")
pkg_dss_tb <- fn_type_lup_tb %>%
  ready4fun::add_rows_to_fn_type_lup(fn_type_nm_chr = ready4fun::get_new_fn_types(abbreviations_lup = abbreviations_lup,
                                                                                  fn_type_lup_tb = fn_type_lup_tb),
                                     fn_type_desc_chr = c("Extracts data from an object.",
                                                          "Renames elements of an object based on a pre-speccified schema."
                                                          ),
                                     is_generic_lgl = F,
                                     is_method_lgl = F) %>% # Add to ready4fun template.
  dplyr::arrange(fn_type_nm_chr) %>%
  ready4fun::write_dmtd_fn_type_lup(url_1L_chr = NA_character_,
                                    abbreviations_lup = abbreviations_lup,
                                    pkg_dss_tb = pkg_dss_tb)
utils::data("fn_type_lup_tb")

#
# 6. Create a table of all functions to document
fns_dmt_tb <- ready4fun::make_dmt_for_all_fns(paths_ls = ready4fun::make_fn_nms()[1],
                                              undocumented_fns_dir_chr = ready4fun::make_undmtd_fns_dir_chr()[1],
                                              custom_dmt_ls = list(details_ls = NULL,
                                                                   inc_for_main_user_lgl_ls = list(force_true_chr = c("add_aqol6d_predn_to_ds","add_qalys_to_ds",
                                                                                                                      "get_mdl_from_dv","get_mdls_using_predrs","get_tfmn_from_lup",
                                                                                                                      "make_he_smry","make_sngl_grp_ds","make_matched_ds",
                                                                                                                      "rename_from_nmd_vec"),
                                                                                                   force_false_chr = NA_character_),
                                                                   args_ls_ls = NULL),
                                              fn_type_lup_tb = fn_type_lup_tb,
                                              abbreviations_lup = abbreviations_lup)
pkg_dss_tb <- fns_dmt_tb %>%
  ready4fun::write_and_doc_ds(db_1L_chr = "fns_dmt_tb",
                              title_1L_chr = "youthu function documentation table",
                              desc_1L_chr = "Meta-data on each youthu function used to create package documentation",
                              url_1L_chr = "https://ready4-dev.github.io/youthu/",
                              abbreviations_lup = abbreviations_lup,
                              pkg_dss_tb = pkg_dss_tb)
##

pkg_dss_tb <- tibble::tibble(short_name_chr = c("BADS","GAD7","K6","OASIS","PHQ9","SCARED","SOFAS"),
                             long_name_chr = short_name_chr %>% purrr::map_chr(~paste0(.x, " total score")),
                             min_val_dbl = rep(0,7),
                             max_val_dbl = c(150,21,24,20,27,82,100),
                             class_chr = "integer",
                             increment_dbl = rep(1,7),
                             class_fn_chr = paste0("firstbounce_",tolower(short_name_chr)),
                             mdl_scaling_dbl = 0.01,
                             covariate_lgl = c(rep(F,6),T)) %>%
  ready4fun::write_and_doc_ds(db_1L_chr = "predictors_lup",
                              title_1L_chr = "Predictors lookup table",
                              desc_1L_chr = "A lookup table of the short name and long name of each predictor used in the models included with the youthu package.",
                              abbreviations_lup = abbreviations_lup,
                              pkg_dss_tb = pkg_dss_tb)
# pkg_dss_tb <- ready4use::ready4_dv_import_lup() %>%
#   tibble::add_case(data_repo_db_ui = "https://doi.org/10.7910/DVN/JC6PTV",
#                    file_name = "mdls_smry_tb",
#                    file_type = ".csv",
#                    data_repo_file_ext = ".tab") %>%
#   ready4use::get_data() %>%
#   ready4fun::write_and_doc_ds(db_1L_chr = "mdls_smry_tb",
#                               title_1L_chr = "Summary coefficients for youthu transfer to utility models",
#                               desc_1L_chr = "A summary of the models included in the youthu package that can be used to predict adolescent AQoL6D. Note this summary is a placeholder as all models have been estimated from synthetic data.",
#                               abbreviations_lup = abbreviations_lup,
#                               pkg_dss_tb = pkg_dss_tb)
# utils::data("mdls_smry_tb")
mdls_smry_tb <- ready4use::ready4_dv_import_lup() %>%
  tibble::add_case(data_repo_db_ui = "https://doi.org/10.7910/DVN/JC6PTV", # NOT UP TO DATE
                   file_name = "mdls_smry_tb",
                   file_type = ".csv",
                   data_repo_file_ext = ".tab") %>%
  ready4use::get_data()
pkg_dss_tb <- tibble::tibble(mdl_nms_chr = mdls_smry_tb$Model %>% unique()) %>%
  dplyr::mutate(predrs_ls = mdl_nms_chr %>% strsplit("_") %>% purrr::map(~ .x[.x %in% c(predictors_lup$short_name_chr)]),
                mdl_type_chr = mdl_nms_chr %>% strsplit("_") %>% purrr::map(~ .x[.x %in% c("GLM", "OLS")]) %>% purrr::flatten_chr(),
                tfmn_chr = mdl_nms_chr %>% purrr::map_chr(~stringr::str_sub(.x,start = 1 +  stringi::stri_locate_last(.x,fixed = "_")[1,1] %>% as.vector())))  %>%
  ready4fun::write_and_doc_ds(db_1L_chr = "mdls_lup",
                              title_1L_chr = "Lookup table of prediction models",
                              desc_1L_chr = "A summary of the key descriptive features of the prediction models included in the youthu package.",
                              abbreviations_lup = abbreviations_lup,
                              pkg_dss_tb = pkg_dss_tb)
# 7. Save copy of package documentation to online data repo.
# ds_ls <- ready4use::write_pkg_dss_to_dv_ds_csvs(pkg_dss_tb,
#                                                 dv_nm_1L_chr = "ready4models",
#                                                 ds_url_1L_chr = "https://doi.org/10.7910/DVN/RXGPAT",
#                                                 parent_dv_dir_1L_chr = "../../../../../Data/Dataverse",
#                                                 wait_time_in_secs_int = 5L)
# NOTE: NEED TO UPDATE DIR PATH FOR MODELS
## Note files to be rewritten cannot be open in RStudio.
## 8. Document functions.
usethis::use_build_ignore("initial_setup.R")
usethis::use_package("knitrBootstrap")
usethis::use_package("truncnorm")
usethis::use_dev_package("ready4show")
usethis::use_dev_package("ready4use")
usethis::use_dev_package("TTU")
readLines(".github/workflows/R-CMD-check.yaml")[-28] %>%
  writeLines(".github/workflows/R-CMD-check.yaml")
ready4fun::write_and_doc_fn_fls(fns_dmt_tb,
                                r_dir_1L_chr = "R",
                                dev_pkgs_chr = c("ready4fun","ready4show","ready4use","TTU","dataverse"),
                                update_pkgdown_1L_lgl = T,
                                path_to_dvpr_dmt_dir_1L_chr = "../../../../../Documentation/Code/Developer",
                                path_to_user_dmt_dir_1L_chr = "../../../../../Documentation/Code/User")
# devtools::build_vignettes()
