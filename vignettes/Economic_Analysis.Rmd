---
title: "Economic analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Economic analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
params:
  output_type_1L_chr: HTML
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
library(youthu)
set.seed(1234)
```
# Motivation
The main motivation behind the youthu package is to extend the types of economic analysis that can be undertaken with both single group (e.g. pilot study, health service records) and matched groups (e.g. trial) datasets that do not include measures of health utility.

# Data requirements
To use youthu to predict health utility for for records in a dataset, it is necessary for that dataset to [include one or more of the predictors used in the youthu models](Prediction_With_Mdls.html). In the examples illustrated in this article, we have selected PHQ9 and SOFAS predictors.

Furthermore, to use health utility predictions in economic analysis, a dataset requires some additional features: 
 - a single group dataset must also include unique unit identifier, data collection round, data collection date and duration of study participation variables;
 - a matched group dataset needs all of the required variables for a single group dataset plus variables specifying group membership and match identifier.
 
For both single group and matched group datasets, inclusion of a cost variable will extend the types of economic analysis that can be undertaken. 

To illustrate the application of youthu functions to each type of dataset, we create synthetic (fake) data. To do so, we first make a list object that summarises the desired features of these datasets, such as:
 - the name of variables for unique unit identifier, data collection round, data collection date and health utility measure;
 - the allowed values of the data collection round variable,

```{r}
ds_smry_ls <- list(date_var_nm_1L_chr = "date_psx",
id_var_nm_1L_chr = "fkClientID",
round_var_nm_1L_chr = "round",
round_lvls_chr = c("Baseline","Follow-up"), 
utl_var_nm_1L_chr = "AQoL6D_HU")
```
## Single group dataset
We pass these list of dataset parameters, along with a four variable (PHQ9, SOFAS, record identified and data collection round) subset of the youthu `replication_popl_tb` [replication dataset](Replication_DS.html), to two youthu helper functions for working with synthetic data. The first helper function is `add_dates_from_dist`{.R}, which we use to add the dates at which each participant entered the study (randomly sampled from a sequence of 180 consecutive days from the last year), the duration of study participation for each individual (sampled from a truncated normal distribution, bounded between 80 and 110 days) and the dates of each participant's follow-up assessment. 

```{r}
sngl_grp_ds_tb <- youthu::replication_popl_tb %>%
  dplyr::select(fkClientID,round,PHQ9, SOFAS) %>% #
  na.omit() %>%
  dplyr::mutate(SOFAS = as.integer(round(SOFAS,0))) %>%
  tibble::as_tibble() %>%
  add_dates_from_dist(bl_start_date_dtm = Sys.Date() - lubridate::days(300),
                       bl_end_date_dtm = Sys.Date() - lubridate::days(120),
                       duration_args_ls = list(a = 80, b = 110, mean = 90, sd = 7),
                       duration_fn = truncnorm::rtruncnorm,
                       date_var_nm_1L_chr = ds_smry_ls$date_var_nm_1L_chr,
                       id_var_nm_1L_chr = ds_smry_ls$id_var_nm_1L_chr,
                       round_var_nm_1L_chr = ds_smry_ls$round_var_nm_1L_chr,
                       round_bl_val_1L_chr = ds_smry_ls$round_lvls_chr[1]) 
```
The second helper function is `add_costs_by_tmpt`{.R}, which we use to add a cost variable with gamma distributed costs that have **population** (not sample) mean values of \$300 for a defined period up to baseline and \$1500 for the costs accrued between baseline and follow-up. 

```{r}
sngl_grp_ds_tb <- sngl_grp_ds_tb  %>%
  add_costs_by_tmpt(round_var_nm_1L_chr = ds_smry_ls$round_var_nm_1L_chr,
                    round_lvls_chr = ds_smry_ls$round_lvls_chr,
                    costs_mean_dbl = c(300,1500),
                    costs_sd_dbl = c(100,120),
                    fn = add_costs_from_gamma_dist) 
```

The resulting single group dataset contains `r nrow(sngl_grp_ds_tb)` records, with a snapshot provided below.

```{r}
sngl_grp_ds_tb %>% dplyr::arrange(fkClientID) %>% head()
```
The `r sngl_grp_ds_tb %>% dplyr::filter(round == "Baseline") %>% nrow()` baseline records are summarised below.
```{r}
(sngl_grp_ds_tb %>% dplyr::filter(round == "Baseline"))[3:7] %>% summary()
```
The summary of `r sngl_grp_ds_tb %>% dplyr::filter(round == "Follow-up") %>% nrow()` follow-up records:
```{r}
(sngl_grp_ds_tb %>% dplyr::filter(round == "Follow-up"))[3:7] %>% summary()
```
## Matched group dataset
To create a matched group dataset
The final helper function is `make_fake_trial_ds`{.R}, which we use to split our single group dataset into two propensity score matched groups - one each for intervention and control. We also use this function to build in our assumptions about the **population** (not sample) distributions for group differences in changes in PHQ9, SOFAS and costs between baseline and follow-up.

 -comparison group variable name and allowed values,
 - the variables that we want to match on to create comparable intervention and control groups; and
  - the variables which we will manipulate in order to create differences between the intervention and control groups.
```{r}
matched_ds_tb <- sngl_grp_ds_tb %>%
make_fake_trial_ds(id_var_nm_1L_chr = ds_smry_ls$id_var_nm_1L_chr,
                   round_var_nm_1L_chr = ds_smry_ls$round_var_nm_1L_chr,
                   round_lvls_chr = ds_smry_ls$round_lvls_chr,
                   match_on_vars_chr = c("PHQ9","SOFAS","costs_dbl"),
                   cmprsn_var_nm_1L_chr = "study_arm_chr",
                   cmprsn_groups_chr = c("Intervention","Control"),
                   fns_ls = list(rnorm,rnorm,rnorm),
                   var_nms_chr = c("PHQ9","SOFAS","costs_dbl"),
                   abs_mean_diff_dbl = c(6,8,300),
                   diff_sd_dbl = c(7,10,400),
                   multiplier_dbl = c(1,-1,1),
                   min_dbl = c(0,0,0),
                   max_dbl = c(27,100,Inf),
                   integer_lgl = c(T,T,F)) %>%
  dplyr::mutate(dplyr::across(c("PHQ9","SOFAS"),as.integer))
```

The resulting dataset includes `r matched_ds_tb$match_idx_int %>% unique() %>% length()` matched comparisons, with each comparison containing baseline and follow-up records for one intervention arm participant and one control arm participant. The first few records are as follows.

```{r}
matched_ds_tb %>% head()
```


```{r}
summary((matched_ds_tb %>% dplyr::filter(study_arm_chr == "Control" & round == "Baseline"))[3:7])
```
```{r}
summary((matched_ds_tb %>% dplyr::filter(study_arm_chr == "Intervention" & round == "Baseline"))[3:7])
```
```{r}
summary((matched_ds_tb %>% dplyr::filter(study_arm_chr == "Control" & round == "Follow-up"))[3:7])
```
```{r}
summary((matched_ds_tb %>% dplyr::filter(study_arm_chr == "Intervention" & round == "Follow-up"))[3:6])
```

## The usefulness of health utility for economic analyses
Firstly, consider the case of a trial dataset examining differences in clinical, functional and healthcare resource use outcomes between intervention and control arms but containing no measure of health utility. The most feasible economic evaluation types to apply to this dataset are cost-consequence analysis (where a synopsis of the differences in a range of measures are presented alongside cost differences for a decision maker to interpret subjectively) and cost-effectiveness analysis (where a statistic - the incremental cost-effectiveness ratio or ICER - is calculated by dividing differences in costs by differences in a single outcome measure).

The policy implications of these two types of economic studies can be relatively simple to interpret if either the intervention or control arm is simultaneously cheaper and more effective across all included outcome measures. However, frequently a new intervention proves to be both more effective and more costly, in which case the policy message of such studies is much less clear due to the following limitations of each evaluation type:

- In cost consequence analyses, the lack of any formal weighting for each of the included outcome measures makes it harder to interpret situations where an intervention has different directions of impact across different outcomes (e.g. greater improvements in functional outcomes than the comparator, but not as much clinical improvement as in the control arm).
- In cost effectiveness analyses, the (probable) lack of any consensus value for a decision-maker's willingness to pay for improvements in the selected benefit measure mean the ICER statistic is not especially informative (e.g. is it good or bad value for money if it is necessary to pay \$100 for each unit of improvement on a clinical scale; is that intervention a better use of a decision maker's budget than an intervention that costs \$100 for a one point improvement on a different clinical scale for a different patient population?). 

These types of short-comings can be significantly addressed by undertaking cost-utility analyses as:

- it uses a measure of benefit - quality adjusted life years (QALYs) - that captures multiple, weighted domains of health in a single index measure that can be applied across health conditions;
- there are published benchmark willingness to pay values for use by decision makers in many countries to make ICER statistics readily interpretable.


# Prediction model

```{r}
candidate_mdls_tb <- get_mdls_using_predrs(predictors_lup$short_name_chr[c(5,7)])
model_mdl <- get_mdl_from_dv(candidate_mdls_tb$mdl_nms_chr[4])
```

# Types of economic analysis facilitated by youthu
There are four types of economic analysis in youth mental health that youthu can help with:

- Extending cost-consequence and cost-effectiveness economic evaluations to include cost-utility analyses that are easier for healthcare policy-makers to interpret;
- Extending efficacy trials with a modelled analysis exploring the plausibility of the potential cost-effectiveness of study interventions;
- Extending single group datasets (e.g. health service records, pilot studys) with a modelled analysis of the potential for hypothethised interventions being cost-effective; and
- Assessing the potential economic value of alternative intervention research proposals.

## Extending cost-consequence and cost-effectiveness economic evaluations



This example illustrates how youthu can be used to undertake cost-utility analysis in an economic evaluation dataset that does not contain any measure of health utility.




```{r}
econ_cmprsn_ds_tb <- add_aqol6d_predn_to_ds(data_tb = matched_ds_tb,
                                   model_mdl = model_mdl,
                                   tfmn_1L_chr = get_tfmn_from_lup(candidate_mdls_tb$mdl_nms_chr[4]),
                                   utl_var_nm_1L_chr = ds_smry_ls$utl_var_nm_1L_chr,
                                   id_var_nm_1L_chr = ds_smry_ls$id_var_nm_1L_chr,
                                   round_var_nm_1L_chr = ds_smry_ls$round_var_nm_1L_chr,
                                   round_bl_val_1L_chr = ds_smry_ls$round_lvls_chr[1]) %>%
  dplyr::select(fkClientID, round, study_arm_chr, date_psx, duration_prd, dplyr::everything())
```

```{r}
econ_cmprsn_ds_tb %>% head()
```
```{r}
add_change_in_utl <- function(ds_tb,
                             id_var_nm_1L_chr = "fkClientID",
                             round_var_nm_1L_chr = "round",
                             round_bl_val_1L_chr = "Baseline",
                             utl_change_var_nm_1L_chr = "utl_change_dbl",
                             utl_var_nm_1L_chr = "utility_dbl",
                             arrange_by_id_lgl = T){
 updated_ds_tb <-  ds_tb %>%
  dplyr::group_by(!!rlang::sym(id_var_nm_1L_chr)) %>%
  dplyr::mutate(!!rlang::sym(utl_change_var_nm_1L_chr) := dplyr::case_when(!!rlang::sym(round_var_nm_1L_chr ) == round_bl_val_1L_chr ~ 0,
                                        T ~ (as.numeric(!!rlang::sym(utl_var_nm_1L_chr)) - dplyr::lag(as.numeric(!!rlang::sym(utl_var_nm_1L_chr)))))) %>% dplyr::ungroup() 
 if(arrange_by_id_lgl)
 updated_ds_tb <-  updated_ds_tb %>%
  dplyr::arrange(!!rlang::sym(id_var_nm_1L_chr))
 return(updated_ds_tb)
}
add_qalys <- function(ds_tb,
                      utl_change_var_nm_1L_chr = "utl_change_dbl",
                      utl_var_nm_1L_chr = "utility_dbl",
                      duration_var_nm_1L_chr = "duration_prd",
                      qalys_var_nm = "qalys_dbl"){
 updated_ds_tb <- ds_tb %>%
    dplyr::mutate(!!rlang::sym(qalys_var_nm) := (!!rlang::sym(utl_var_nm_1L_chr)-(!!rlang::sym(utl_change_var_nm_1L_chr) * 0.5)) * (duration_prd / lubridate::years(1)))
  return(updated_ds_tb)
}
econ_cmprsn_ds_tb <- econ_cmprsn_ds_tb %>% add_change_in_utl(utl_var_nm_1L_chr = ds_smry_ls$utl_var_nm_1L_chr) %>% 
  add_qalys(utl_change_var_nm_1L_chr = "utl_change_dbl", 
            utl_var_nm_1L_chr = ds_smry_ls$utl_var_nm_1L_chr,
            duration_var_nm_1L_chr = "duration_prd",
                      qalys_var_nm = "qalys_dbl")

```
```{r}
econ_cmprsn_ds_tb %>% head()
```

```{r}
econ_cmprsn_ds_tb %>% dplyr::filter(round == "Follow-up", study_arm_chr == "Control") %>% summary()
```

```{r}
econ_cmprsn_ds_tb %>% dplyr::filter(round == "Follow-up", study_arm_chr == "Intervention") %>% summary()
```
```{r}
300/(0.1647-0.15505)
```

