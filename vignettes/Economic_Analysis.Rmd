---
title: "Economic analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Economic analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
params:
  output_type_1L_chr: HTML
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r message=FALSE}
library(youthu)
set.seed(1234)
```
# Introduction

## Motivation
The main motivation behind the youthu package is to extend the types of economic analysis that can be undertaken with both single group (e.g. pilot study, health service records) and matched groups (e.g. trial) datasets that do not include measures of health utility.

## Example datasets
To illustrate the input data requirements and the practical application of youthu functions, we adapt the youthu `replication_popl_tb` [replication dataset](Replication_DS.html) to create synthetic (fake) single group and matched group datasets. To do so, we first make a list object `ds_smry_ls` that summarises the desired features of these datasets, such as:

 - the names of the predictors for utility to be included in the dataset;
 - the name of variables for unique unit identifier, data collection round, data collection date, costs and health utility measure;
 - (for matched dataset only) the name of the variable for comparison group and the allowable values for that variable;
 - the allowed values of the data collection round variable, the dates during which baseline data measures are collected (randomly sampled from a sequence of 180 consecutive days from the last year) and distribution parameters for the duration between baseline and follow-up timepoints (sampled from a truncated normal distribution, bounded between 80 and 110 days);
 - **population** (not sample) parameters to generate gamma distributed costs for periods prior to study entry(mean \$300) and between baseline and follow-up measurements (mean \$1500) for the whole single group dataset or the control arm of a matched dataset;
 
```{r}
ds_smry_ls <- list(bl_start_date_dtm = Sys.Date() - lubridate::days(300),
                   bl_end_date_dtm = Sys.Date() - lubridate::days(120),
                   cmprsn_var_nm_1L_chr = "study_arm_chr",
                   cmprsn_groups_chr = c("Intervention","Control"),
                   costs_mean_dbl = c(300,1500),
                   costs_sd_dbl = c(100,120),
                   costs_var_nm_1L_chr = "costs_dbl",
                   date_var_nm_1L_chr = "date_psx",
                   duration_args_ls = list(a = 80, b = 110, mean = 90, sd = 7),
                   duration_fn = truncnorm::rtruncnorm,
                   id_var_nm_1L_chr = "fkClientID",
                   predr_var_nms = c("PHQ9", "SOFAS"),
                   round_var_nm_1L_chr = "round",
                   round_lvls_chr = c("Baseline","Follow-up"), 
                   utl_var_nm_1L_chr = "AQoL6D_HU")

```
We pass both the `ds_smry_ls` summary list and `replication_popl_tb` replication dataset to the `make_sngl_grp_ds`{.R} function to create an example single group dataset.
```{r}
sngl_grp_ds_tb <- make_sngl_grp_ds(replication_popl_tb,ds_smry_ls = ds_smry_ls)
```
We can split a subset of our single group dataset into two propensity score matched groups - one each for intervention and control - using the `make_matched_ds`{.R} function. We also use this function to build in our assumptions about group differences in changes in PHQ9, SOFAS and costs measured at follow-up. The below example assumes **population** (not sample) mean differences between Intervention and Control arms of -2 for PHQ9, +4 for SOFAS and +$300 for costs.

```{r}
matched_ds_tb <- make_matched_ds(sngl_grp_ds, 
                                 cmprsn_smry_tb = tibble::tibble(var_nms_chr = c(ds_smry_ls$predr_var_nms, ds_smry_ls$costs_var_nm_1L_chr),
                                 fns_ls = list(rnorm,rnorm,rnorm),
                                 abs_mean_diff_dbl = c(3,2,300),
                                 diff_sd_dbl = c(2,2,200),
                                 multiplier_dbl = c(-1,1,1),
                                 min_dbl = c(0,0,0),
                                 max_dbl = c(27,100,Inf),
                                 integer_lgl = c(T,T,F)), 
                                 ds_smry_ls = ds_smry_ls)
```

# Economic analysis of matched group datasets

## Data requirements
The synthetic matched dataset we generated includes `r matched_ds_tb$match_idx_int %>% unique() %>% length()` matched comparisons, with each comparison containing baseline and follow-up records for one intervention arm participant and one control arm participant. The first few records are as follows.

```{r}
matched_ds_tb %>% head()
```
This dataset contains features that make it possible to use in conjunction with youthu's economic analysis functions. Specifically these requirements are that the dataset must:

- [include one or more of the predictors used in the youthu models](Prediction_With_Mdls.html) (in this case PHQ9 and SOFAS);
 - include variables for unique study participant identifier, data collection round, data collection date, interval between baseline and follow-up, study arm assignment and record matching; and
 - be in long format where each row represents ***either*** a baseline or follow-up measurement for a unique study participant.
 
The synthetic matched dataset also contains a cost variable, which is a requirement for most, though not all, of the economic analyses that can be undertaken with youthu. 

## Limitations of datasets without measures of health utility
A notable omission from the fake study dataset is any measure of utility. This omission means that, in the absence of using mapping algorithms such as those included with youthu, the most feasible types of economic evaluation to apply to this dataset would likely be cost-consequence analysis (where a synopsis of the differences in a range of measures are presented alongside cost differences for a decision maker to interpret subjectively) and cost-effectiveness analysis (where a statistic - the incremental cost-effectiveness ratio or ICER - is calculated by dividing differences in costs by differences in a single outcome measure).

These types of economic analyses can be relatively simple to interpret if either the intervention or control arm is simultaneously cheaper and more effective across all included outcome measures. However, these conditions don't hold in our sample data.

```{r}
summary((matched_ds_tb %>% dplyr::filter(study_arm_chr == "Control" & round == "Baseline"))[5:6])
```
```{r}
summary((matched_ds_tb %>% dplyr::filter(study_arm_chr == "Control" & round == "Follow-up"))[5:7])
```

```{r}
summary((matched_ds_tb %>% dplyr::filter(study_arm_chr == "Intervention" & round == "Baseline"))[5:6])
```

```{r}
summary((matched_ds_tb %>% dplyr::filter(study_arm_chr == "Intervention" & round == "Follow-up"))[5:7])
```

However, frequently a new intervention proves to be both more effective and more costly, in which case the policy message of such studies is much less clear due to the following limitations of each evaluation type:

- In cost consequence analyses, the lack of any formal weighting for each of the included outcome measures makes it harder to interpret situations where an intervention has different directions of impact across different outcomes (e.g. greater improvements in functional outcomes than the comparator, but not as much clinical improvement as in the control arm).
- In cost effectiveness analyses, the (probable) lack of any consensus value for a decision-maker's willingness to pay for improvements in the selected benefit measure mean the ICER statistic is not especially informative (e.g. is it good or bad value for money if it is necessary to pay \$100 for each unit of improvement on a clinical scale; is that intervention a better use of a decision maker's budget than an intervention that costs \$100 for a one point improvement on a different clinical scale for a different patient population?). 

These types of short-comings can be significantly addressed by undertaking cost-utility analyses as:

- it uses a measure of benefit - quality adjusted life years (QALYs) - that captures multiple, weighted domains of health in a single index measure that can be applied across health conditions;
- there are published benchmark willingness to pay values for use by decision makers in many countries to make ICER statistics readily interpretable.


# Prediction model

```{r}
candidate_mdls_tb <- get_mdls_using_predrs(predictors_lup$short_name_chr[c(5,7)])
model_mdl <- get_mdl_from_dv(candidate_mdls_tb$mdl_nms_chr[4])
```

# Types of economic analysis facilitated by youthu
There are four types of economic analysis in youth mental health that youthu can help with:

- Extending cost-consequence and cost-effectiveness economic evaluations to include cost-utility analyses that are easier for healthcare policy-makers to interpret;
- Extending efficacy trials with a modelled analysis exploring the plausibility of the potential cost-effectiveness of study interventions;
- Extending single group datasets (e.g. health service records, pilot studys) with a modelled analysis of the potential for hypothethised interventions being cost-effective; and
- Assessing the potential economic value of alternative intervention research proposals.

## Extending cost-consequence and cost-effectiveness economic evaluations

This example illustrates how youthu can be used to undertake cost-utility analysis in an economic evaluation dataset that does not contain any measure of health utility.

```{r}
econ_cmprsn_ds_tb <- add_aqol6d_predn_to_ds(data_tb = matched_ds_tb,
                                   model_mdl = model_mdl,
                                   tfmn_1L_chr = get_tfmn_from_lup(candidate_mdls_tb$mdl_nms_chr[4]),
                                   utl_var_nm_1L_chr = ds_smry_ls$utl_var_nm_1L_chr,
                                   id_var_nm_1L_chr = ds_smry_ls$id_var_nm_1L_chr,
                                   round_var_nm_1L_chr = ds_smry_ls$round_var_nm_1L_chr,
                                   round_bl_val_1L_chr = ds_smry_ls$round_lvls_chr[1]) %>%
  dplyr::select(fkClientID, round, study_arm_chr, date_psx, duration_prd, dplyr::everything())
```
```{r}
econ_cmprsn_ds_tb %>% head()
```

```{r}
args_ls_ls <- purrr::map(c(c("PHQ9","SOFAS"),
             ds_smry_ls$utl_var_nm_1L_chr),
           ~ list(change_var_nm_1L_chr = paste0(.x,"_change_dbl"),
                       var_nm_1L_chr = .x))
econ_cmprsn_ds_tb <- purrr::reduce(1:length(args_ls_ls),
                                   .init = econ_cmprsn_ds_tb,
                                   ~ add_change_in_ds_var(.x,
                                                          var_nm_1L_chr = args_ls_ls[[.y]]$var_nm_1L_chr,
                                                          change_var_nm_1L_chr = args_ls_ls[[.y]]$change_var_nm_1L_chr)) %>%
  add_qalys(utl_change_var_nm_1L_chr = paste0(ds_smry_ls$utl_var_nm_1L_chr,"_change_dbl"), 
            utl_var_nm_1L_chr = ds_smry_ls$utl_var_nm_1L_chr,
            duration_var_nm_1L_chr = "duration_prd",
                      qalys_var_nm_1L_chr = "qalys_dbl")
```

```{r}
econ_cmprsn_ds_tb %>% head()
```
```{r}
# var_nms_chr <- paste0(c("costs_dbl","qalys_dbl", paste0(c("PHQ9","SOFAS","AQOL6D_HU"), "_change_dbl")),"_Follow-up")
  
```

```{r}
he_smry_ls <- econ_cmprsn_ds_tb %>% make_he_smry(change_vars_chr = c("PHQ9","SOFAS","AQoL6D_HU"),
                                                 wtp_dbl = 50000,
                                                 bootstrap_iters_1L_int = 100,
                                                 change_types_chr = c("dbl","dbl","dbl"),
                                                 benefits_pfx_1L_chr = "qalys_dbl",
                                                 benefits_var_nm_1L_chr = "qalys",
                                                 costs_pfx_1L_chr = "costs_dbl",
                                                 costs_var_nm_1L_chr = "costs",
                                                 change_sfx_1L_chr = "change",
                                                 cmprsn_groups_chr = c("Intervention","Control"),
                                                 cmprsn_var_nm_1L_chr = "study_arm_chr",
                                                 round_fup_1L_chr = "Follow-up")
```

```{r}
# named_mat <- bootstraps_ls$t
# colnames(named_mat) <- names(bootstraps_ls$t0)
```

```{r}
evpi_ls <- BCEA::evppi(names(he_smry_ls$bootstraps_ls$t0)[c(1,3)],
            input = he_smry_ls$named_mat,
            he = he_smry_ls$ce_res_ls)
```
```{r fig.width=6}
BCEA::plot.evppi(evpi_ls, graph = "ggplot2")
```

```{r fig.width=6}
BCEA::eib.plot(he_smry_ls$ce_res_ls)
```

```{r fig.width=6}
BCEA::evi.plot(he_smry_ls$ce_res_ls,
               graph = "ggplot2")
```

```{r fig.width=6}
BCEA::ceac.plot(he_smry_ls$ce_res_ls,
                graph = "ggplot2",
          #title = "my title",
          line_colors = "green",
          theme = ggplot2::theme_dark())

```
```{r fig.width=6}
BCEA::ceplane.plot(he_smry_ls$ce_res_ls, wtp =50000,    
                   # line = list(colors = "green"),
                   area_color = "green",
                    graph = "ggplot2",
          theme = ggplot2::theme_light())
```
## Matched groups details


## Single group details
The `r sngl_grp_ds_tb %>% dplyr::filter(round == "Baseline") %>% nrow()` baseline records are summarised below.
```{r}
(sngl_grp_ds_tb %>% dplyr::filter(round == "Baseline"))[4:7] %>% summary()
```
The summary of `r sngl_grp_ds_tb %>% dplyr::filter(round == "Follow-up") %>% nrow()` follow-up records:
```{r}
(sngl_grp_ds_tb %>% dplyr::filter(round == "Follow-up"))[4:7] %>% summary()
```
We add a cost variable with gamma distributed costs that have  mean values of \$300 for a defined period up to baseline and \$1500 for the costs accrued between baseline and follow-up. 
The resulting single group dataset contains `r nrow(sngl_grp_ds_tb)` records, with a snapshot provided below.

```{r}
sngl_grp_ds_tb  %>% head()
```
