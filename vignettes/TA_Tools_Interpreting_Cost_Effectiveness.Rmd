---
title: "Interpreting Cost-Effectiveness"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Interpreting Cost-Effectiveness}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
params:
  output_type_1L_chr: HTML
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Dominant is easy, if not dominant we need a willingness to pay threshold.

```{r}
make_fake_trial_ds <- function(ds_tb,
                               predictors_chr,
                               UID_var_nm_1L_chr = "UID_chr",
                               timepoint_var_nm_1L_chr = "Timepoint_chr",
                               timepoint_bl_val_1L_chr = "Baseline",
                               cmprsn_var_nm_1L_chr = "study_arm_chr",
                               cmprsn_groups_chr = c("Intervention","Control")
                ){
 ds_tb <- ds_tb %>%
   transform_ds_for_cmprsn(UID_var_nm_1L_chr = UID_var_nm_1L_chr,
                               timepoint_var_nm_1L_chr = timepoint_var_nm_1L_chr,
                           cmprsn_var_nm_1L_chr = cmprsn_var_nm_1L_chr,
                           cmprsn_groups_chr = cmprsn_groups_chr) %>%
  match_ds_arms(timepoint_var_nm_1L_chr = timepoint_var_nm_1L_chr,
                             timepoint_bl_val_1L_chr = timepoint_bl_val_1L_chr,
                             cmprsn_var_nm_1L_chr = cmprsn_var_nm_1L_chr,
                             active_arm_val_1L_chr = cmprsn_groups_chr[1],
                predictors_chr = predictors_chr)
return(ds_tb)
}
match_ds_arms <- function(ds_tb,
                          timepoint_var_nm_1L_chr = "Timepoint_chr",
                          timepoint_bl_val_1L_chr = "Baseline",
                          cmprsn_var_nm_1L_chr = "study_arm_chr",
                          active_arm_val_1L_chr = "Intervention",
                          predictors_chr){
  match_ds <- ds_tb %>% dplyr::filter(!!rlang::sym(timepoint_var_nm_1L_chr) == timepoint_bl_val_1L_chr) %>%
  dplyr::mutate(Intervention_lgl = dplyr::case_when(!!rlang::sym(cmprsn_var_nm_1L_chr) == active_arm_val_1L_chr ~ T,
                                                    T ~ F)) 
matched_ls <- make_formula("Intervention_lgl",
                           predictors_chr = predictors_chr) %>%
  MatchIt::matchit(data = match_ds, method = "nearest", ratio = 1)
matched_ds_tb <- MatchIt::match.data(matched_ls) 
match_key_ds_tb <- c(F,T) %>% purrr::map_dfr(~matched_ds_tb %>% dplyr::filter(Intervention_lgl == .x) %>% dplyr::arrange(distance) %>% dplyr::mutate(match_idx_int = 1:dplyr::n())) %>% dplyr::arrange(match_idx_int) %>% dplyr::select(UID, study_arm_chr, match_idx_int)
matched_ds_tb <- dplyr::right_join(ds_tb,match_key_ds_tb) %>% dplyr::arrange(match_idx_int)
return(matched_ds_tb)
}
make_formula <- function(dep_var_nm_1L_chr,
                         predictors_chr,
                         environment_env = parent.frame()){
  formula_fml <- formula(paste0(dep_var_nm_1L_chr,
         " ~ ",
         paste0(predictors_chr, collapse = " + ")), env = environment_env)
  return(formula_fml)
}
transform_ds_for_cmprsn <- function(ds_tb,
                                    cmprsn_var_nm_1L_chr,
                               UID_var_nm_1L_chr = "UID_chr",
                               timepoint_var_nm_1L_chr = "Timepoint_chr",
                               cmprsn_groups_chr = c("Intervention","Control")){
  ds_tb <- ds_tb %>%
  dplyr::group_by(!!rlang::sym(UID_var_nm_1L_chr)) %>%
  dplyr::mutate(n_measures_int = dplyr::n()) %>%
  dplyr::ungroup() %>%
  dplyr::filter(n_measures_int == 2)
  UIDs_with_FUP_data_chr <- ds_tb  %>% dplyr::pull(!!rlang::sym(UID_var_nm_1L_chr)) %>% unique()
group_1_IDs <- sample(UIDs_with_FUP_data_chr, floor(length(UIDs_with_FUP_data_chr)/2))
group_2_IDs <- setdiff(UIDs_with_FUP_data_chr,group_1_IDs)[1:length(group_1_IDs)]
ds_tb <- ds_tb %>% dplyr::mutate(!!rlang::sym(cmprsn_var_nm_1L_chr) := dplyr::case_when(!!rlang::sym(UID_var_nm_1L_chr) %in% group_1_IDs ~ cmprsn_groups_chr[1],
                                                                  !!rlang::sym(UID_var_nm_1L_chr) %in% group_2_IDs ~ cmprsn_groups_chr[2],
                                                                  T ~ NA_character_
                                                                  )) %>%
    dplyr::select(-n_measures_int) %>%
  dplyr::filter(!!rlang::sym(cmprsn_var_nm_1L_chr) %in% cmprsn_groups_chr) 
return(ds_tb)
}
add_costs_from_gamma_dist <- function(ds_tb,
                                      costs_mean_dbl,
                                      costs_sd_dbl,
                                      costs_var_nm_1L_dbl = "costs_dbl"){

   updated_ds_tb <- dplyr::mutate(ds_tb, 
                                  !!rlang::sym(costs_var_nm_1L_dbl) := make_costs_vec_from_gamma_dist(n_int  =nrow(ds_tb),
                                           costs_mean_dbl = costs_mean_dbl,
                                           costs_sd_dbl = costs_sd_dbl))
   return(updated_ds_tb)
  
}
make_costs_vec_from_gamma_dist <- function(n_int,
                                           costs_mean_dbl,
                                           costs_sd_dbl){
    scale_1L_dbl <- costs_sd_dbl^2/costs_mean_dbl
   shape_1L_dbl <- costs_mean_dbl / scale_1L_dbl
   costs_dbl <- rgamma(n_int,shape = shape_1L_dbl, scale = scale_1L_dbl)
   return(costs_dbl)
}
update_col_with_diff <- function(ds_tb,
                                 var_nm_1L_chr,
                                 fn,
                                 abs_mean_diff_1L_dbl,
                                 diff_sd_1L_dbl,
                                 multiplier_1L_dbl,
                                 min_1L_dbl,
                                 max_1L_dbl){
                    args_ls <- append(list(nrow(ds_tb)), list(abs_mean_diff_1L_dbl,
                                                              diff_sd_1L_dbl)) %>% unname()
                  diff_dbl <- (rlang::exec(.fn = fn, !!!args_ls))*multiplier_1L_dbl
                  new_ds <- ds_tb %>%
                    dplyr::mutate(!!rlang::sym(var_nm_1L_chr) := !!rlang::sym(var_nm_1L_chr) %>% purrr::map2_dbl(diff_dbl, ~{
                      new_total_1L_dbl <- .x + .y
                      min(max(new_total_1L_dbl,min_1L_dbl),max_1L_dbl)
                      })
                )
                                      return(new_ds)
}
update_multpl_cols_with_diffs <- function(ds_tb,
                                          var_nms_chr,
                                          fns_ls,
                                          abs_mean_diff_dbl,
                                          diff_sd_dbl,
                                          multiplier_dbl,
                                          min_dbl,
                                          max_dbl){
  
  args_ls_ls <- list(var_nms_chr = var_nms_chr,
     fns_ls = fns_ls,
     abs_mean_diff_dbl = abs_mean_diff_dbl,
     diff_sd_dbl = diff_sd_dbl,
     multiplier_dbl = multiplier_dbl,
     min_dbl = min_dbl,
     max_dbl = max_dbl)
  updated_ds_tb  <- 1:length(args_ls_ls[[1]]) %>%
  purrr::reduce(.init = ds_tb,
                ~{
                  idx_1L_int <- .y
                  args_ls <- args_ls_ls %>% purrr::map(~.x %>% purrr::pluck(idx_1L_int)) %>% unname()
                  rlang::exec(.fn = update_col_with_diff,
                                        ds_tb = .x,
                                        !!!args_ls)
                                      })
  return(updated_ds_tb)
}
## Add make formula fn
## Add costs to ds and to psm formula
```
```{r}
trial_ds_tb <- updated_data_tb 
timepoint_var_nm_1L_chr <- "Timepoint"
trial_ds_tb <- purrr::pmap_dfr(list(c("Baseline","Follow-up"),
                     c(300,1500),
                     c(100,120)),
            ~ {
              args_ls <- list(trial_ds_tb %>%
              dplyr::filter(!!rlang::sym(timepoint_var_nm_1L_chr) == ..1),..2,..3)
              rlang::exec(.fn = add_costs_from_gamma_dist, !!!args_ls)
              }) 
trial_ds_tb <- trial_ds_tb %>%
  make_fake_trial_ds(UID_var_nm_1L_chr = "UID", 
                     timepoint_var_nm_1L_chr = timepoint_var_nm_1L_chr,
                     timepoint_bl_val_1L_chr = "Baseline",
                     predictors_chr = c("PHQ_total","SOFAS_total","costs_dbl"),
                     cmprsn_var_nm_1L_chr = "study_arm_chr",
                     cmprsn_groups_chr = c("Intervention","Control")) 

updated_trial_ds_tb <- update_multpl_cols_with_diffs(ds_tb = trial_ds_tb,
                                                     var_nms_chr = c("PHQ_total","SOFAS_total","costs_dbl"),
     fns_ls = list(rnorm,rnorm,make_costs_vec_from_gamma_dist),
     abs_mean_diff_dbl = c(3,8,300),
     diff_sd_dbl = c(7,10,400),
     multiplier_dbl = c(1,1,1),
     min_dbl = c(0,0,0),
     max_dbl = c(27,100,Inf))

trial_ds_tb 

```

