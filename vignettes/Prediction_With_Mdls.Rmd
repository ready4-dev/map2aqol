---
title: "Predict Adolescent AQoL-6D"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Predict Adolescent AQoL-6D}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
params:
  output_type_1L_chr: HTML
---

```{r message=FALSE}
library(magrittr)
library(youthu)
```

## Identifying suitable transfer to utility algorithms
To use youthu functions to predict health utility values for records in a dataset, it is necessary to identify transfer to utility models that use predictors that are also present in the prediction dataset. 

To identify datasets that contain transfer to utility models compatible with youthu (ie those developped with the [TTU package](https://ready4-dev.github.io/TTU/index.html)), you can use the following command.

```{r}
ttu_dv_dss_tb <- get_ttu_dv_dss("firstbounce")
```
```{r}
ttu_dv_dss_tb
```

To identify the predictors used by the models hosted by that dataverse, use:

```{r}
get_ttu_dv_predrs(ttu_dv_dss_tb)
```
To identify which models use specified subsets of those predictors, use:

```{r}
mdls_lup <- get_mdls_using_predrs(mdl_predrs_in_ds_chr = c("PHQ9 total score",
                                                           "SOFAS total score"),
                                  ttu_dv_dss_tb = ttu_dv_dss_tb)
```
```{r}
mdls_lup
```

To review the summary information about the predictive performance of these models, use:

```{r}
get_dv_mdl_smrys(mdls_lup,
                 mdl_nms_chr = "SOFAS_1_OLS_CLL")

```

More information about a selected model can be found in the online model catalogue, the link to which can be obtained with the following command:

```{r}
get_mdl_ctlg_url(mdls_lup,
                 mdl_nm_1L_chr = "SOFAS_1_OLS_CLL")
```
To retrieve a specified model, use:

```{r}
model_mdl <- get_model(mdls_lup,
                       mdl_nm_1L_chr = "SOFAS_1_OLS_CLL")
```

# ```{r results='hide'}
# ingredients_ls <- get_mdl_metadata(mdls_lup,
#                                    "SOFAS_1_OLS_CLL")
# ```

## Prepare prediction dataset
To illustrate this next step, we have created a prediction dataset that is a modified and simplified version of the study [replication dataset](https://ready4-dev.github.io/youthvars/articles/Replication_DS.html) distributed with the youthvars package. This illustrative dataset reflects the likely real-world circumstance in which the prediction dataset uses a different naming convention to that of the dataset we used to estimate the youth models. 

```{r }
data_tb <- youthvars::replication_popl_tb %>%
  youthvars::transform_raw_ds_for_analysis() %>%
  dplyr::select(fkClientID,round,PHQ9, SOFAS) %>% #
  dplyr::arrange(fkClientID) %>%
  na.omit() %>%
  dplyr::rename(UID = fkClientID,
                Timepoint = round,
                PHQ_total = PHQ9,
                SOFAS_total = SOFAS) %>%
  dplyr::mutate(SOFAS_total = as.integer(round(SOFAS_total,0))) %>%
  tibble::as_tibble()
```
```{r results='hide'}
data_tb %>% head()
```
```{r dstb, echo = F, tab.cap='Illustrative example of a prediction dataset', tab.id = 'dstb', results="asis"}
data_tb %>% 
  head() %>%
  ready4show::print_table(output_type_1L_chr = params$output_type_1L_chr,
                          caption_1L_chr = knitr::opts_current$get("tab.cap"),
                          mkdn_tbl_ref_1L_chr = paste0("tab:",knitr::opts_current$get("tab.id")),
                          add_to_row_ls = NULL) 
```

### Confirm dataset meets other structural requirements
In addition to containing at least one match for the predictors used in youthu models, the prediction dataset must include both a unique client identifier variable and a measurement time-point identifier variable (`factor`{.R} class, with two levels). The dataset also needs to be in long format (ie where measures at different time-points for the same individual are stacked on top of each other in separate rows). We can confirm these conditions hold both by visual inspection of the dataset and investigation of the classes of the unique identified and measurement timepoint variables.

```{r}
data_tb$UID %>% class()
```
```{r}
data_tb$Timepoint %>% class()
levels(data_tb$Timepoint)
```

## Predict utility
To generate utility predictions we use the `add_aqol6d_predn_to_ds`{.R} function. The function needs to be supplied with the prediction dataset (the value passed to argument `data_tb`), the model we are applying to that dataset (`model_mdl`), the transformation associated with that model (`tfmn_1L_chr`, which can be identified by passing the name of the selected model to the `get_tfmn_from_lup`{.R} function) and details of the variable names used in the prediction dataset for the unique identifier (`id_var_nm_1L_chr`) and measurement timepoint (`round_var_nm_1L_chr`) and, for the later, the factor level that represents the baseline timepoint (`round_bl_val_1L_chr`). Additionally, if the prediction dataset uses different variable names for the predictors to those specified in the `predictors_lup`{.R} lookup table, a named vector detailing the correspondence between the two sets of variable names needs to be passed to the `predr_vars_nms_chr` argument. Finally, if you wish to specify the desired variable name to use for the predicted utility values generated by the function, you can do this by passing this name to the `utl_var_nm_1L_chr` argument.

```{r}
updated_data_tb <- add_utl_predn(data_tb,
                                 mdls_lup = mdls_lup,
                                 mdl_nm_1L_chr = "SOFAS_1_OLS_CLL",
                                 id_var_nm_1L_chr = "UID",
                                 make_from_tbl_1L_lgl = T,
                                 model_mdl = model_mdl,
                                 new_data_is_1L_chr = "Simulated",
                                 predr_vars_nms_chr = c(SOFAS = "SOFAS_total"),
                                 round_var_nm_1L_chr = "Timepoint",
                                 round_bl_val_1L_chr = "BL",
                                 utl_var_nm_1L_chr = "AQoL6D_HU")

```
```{r results='hide'}
updated_data_tb %>% head()
```
```{r updtb, echo = F, tab.cap='Prediction dataset with predicted utilities', tab.id = 'updtb', results="asis"}
updated_data_tb %>% 
  head() %>%
  ready4show::print_table(output_type_1L_chr = params$output_type_1L_chr,
                          caption_1L_chr = knitr::opts_current$get("tab.cap"),
                          mkdn_tbl_ref_1L_chr = paste0("tab:",knitr::opts_current$get("tab.id")),
                          add_to_row_ls = NULL) 
```

Our health utility predictions are now available for use and are summarised below.

```{r}
summary(updated_data_tb$AQoL6D_HU)
```


```{r include=FALSE}
#Source: https://stackoverflow.com/questions/60042689/how-to-include-the-description-of-a-data-set-in-rmarkdown
help_text <- function(...) {
  file <- help(...)
  path <- dirname(file)
  dirpath <- dirname(path)
  pkgname <- basename(dirpath)
  RdDB <- file.path(path, pkgname)
  rd <- tools:::fetchRdDB(RdDB, basename(file))
  capture.output(tools::Rd2txt(rd, out="", options=list(underline_titles=FALSE)))
}
help_text(add_aqol6d_predn_to_ds) %>%
  purrr::map_chr(~.x %>% stringr::str_trim())
```
